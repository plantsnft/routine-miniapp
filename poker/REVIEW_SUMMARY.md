# Hellfire Poker Mini App - Comprehensive Review

## Overview

**Hellfire Poker** is a Farcaster mini app for managing ClubGG poker games. It's built with Next.js 15, uses Farcaster Quick Auth for authentication, Neynar SDK for user data, and Supabase for database storage.

## Architecture

### Tech Stack
- **Framework**: Next.js 15 (App Router)
- **Language**: TypeScript
- **Database**: Supabase (PostgreSQL with `poker` schema)
- **Authentication**: Farcaster Quick Auth (JWT tokens)
- **User Data**: Neynar API (`@neynar/nodejs-sdk`)
- **Blockchain**: Base network (Chain ID 8453), USDC payments
- **Styling**: Tailwind CSS with custom theme variables

### Key Dependencies
- `@farcaster/miniapp-sdk` - Farcaster mini app SDK
- `@farcaster/quick-auth` - JWT authentication
- `@farcaster/miniapp-node` - Server-side webhook verification
- `@neynar/nodejs-sdk` - Neynar API client
- `ethers` - Blockchain interactions
- `zod` - Schema validation

## Farcaster Mini App Integration

### Authentication Flow
1. **Client-side** (`AuthProvider.tsx`):
   - Calls `sdk.actions.ready()` to dismiss splash screen
   - Gets JWT token via `sdk.quickAuth.getToken()`
   - Stores token in `sessionStorage` (key: `pokerAuthToken`)
   - Verifies token with `/api/auth/verify`

2. **Server-side** (`lib/auth.ts`):
   - Extracts token from `Authorization: Bearer <token>` header
   - Verifies JWT using `@farcaster/quick-auth`
   - Extracts FID from token payload (`payload.sub`)
   - **CRITICAL**: FID comes ONLY from verified JWT, never from client body/query

### Mini App Initialization
- `MiniAppInitializer.tsx` calls `sdk.actions.ready()` on mount
- Required by Farcaster to dismiss splash screen
- Handles errors gracefully (won't break if not in mini app context)

### Manifest Configuration
- Served at `/.well-known/farcaster.json`
- Generated by `getFarcasterDomainManifest()` in `lib/utils.ts`
- Includes app metadata, icon URL, webhook URL
- Supports account association for signed manifests

### Webhook Integration
- Endpoint: `/api/farcaster/webhook`
- Handles events: `miniapp_added`, `notifications_enabled`, `notifications_disabled`, `miniapp_removed`
- Verifies signatures using `@farcaster/miniapp-node`
- Stores notification tokens for push notifications

## Neynar Integration

### Client Setup
- Located in `lib/neynar.ts`
- Uses `@neynar/nodejs-sdk` with API key from `NEYNAR_API_KEY` env var
- Singleton pattern (cached client instance)

### Usage
1. **User Profile Hydration** (`/api/auth/verify`):
   - Fetches user profile (username, pfp) from Neynar
   - **Non-blocking**: Auth succeeds even if Neynar fails
   - Uses `fetchBulkUsers({ fids: [fid] })`

2. **Wallet Address Lookup** (`lib/neynar-wallet.ts`):
   - Gets player's wallet address from Neynar
   - Used for payment verification
   - Returns primary address (Base network)

3. **Profile Enrichment**:
   - Used in game results, payouts, participants lists
   - Always non-blocking (graceful degradation)

## Database Schema

### Schema: `poker`
All tables are in the `poker` schema (not `public`). Access is controlled via `pokerDb` wrapper.

### Key Tables
- `users` - Farcaster users (FID, username, pfp, wallet)
- `clubs` - Poker clubs (MVP: only Hellfire Club)
- `club_members` - Club membership
- `games` - Scheduled poker games
- `participants` - Player participation (status: 'joined', 'paid', etc.)
- `game_results` - Game results and positions
- `payouts` - Payout records
- `user_blocks` - Global blocklist
- `notification_subscriptions` - Push notification tokens
- `game_requests` - User-requested games (pending approval)

### Database Access
- **Wrapper**: `lib/pokerDb.ts`
- **Safety**: Only allows access to allowlisted tables
- **Schema**: Uses PostgREST headers (`Accept-Profile: poker`)
- **Auth**: Uses service role key (server-side only)

## Core Features

### 1. Game Management
- **Game Types**: `standard`, `large_event`
- **Gating Types**: `open`, `entry_fee`, `stake_threshold`
- **Status Flow**: `scheduled` → `open` → `in_progress` → `completed`/`settled`/`cancelled`
- **Registration**: Open registration for large events (max 99 participants)

### 2. Payment System
- **Entry Fees**: USDC on Base network
- **Payment Flow**: Prepare → Pay → Confirm
- **Verification**: Blockchain transaction verification
- **Escrow**: Smart contract escrow (GameEscrow.sol)
- **Refunds**: Support for game cancellation refunds

### 3. Access Control
- **Open Signup**: Any Farcaster user can join games (no membership required)
- **Blocklist**: Admins can block users globally
- **Permissions**: Club owners, admins, super owner (FID 318447)

### 4. Notifications
- **Push Notifications**: Farcaster native notifications
- **Webhook**: Receives notification tokens from Farcaster
- **Broadcast**: Admins can send notifications to all subscribers
- **Constraints**: Title ≤ 32 chars, body ≤ 128 chars (Farcaster spec)

### 5. Game Requests
- **User Requests**: Non-admins can request games
- **Admin Approval**: Admins approve/reject requests
- **Auto-Creation**: Approved requests become games

## File Structure

```
poker/
├── src/
│   ├── app/
│   │   ├── api/              # API routes
│   │   │   ├── auth/         # Authentication
│   │   │   ├── clubs/        # Club management
│   │   │   ├── games/        # Game CRUD, join, payment
│   │   │   ├── payments/     # Payment flow
│   │   │   ├── notifications/ # Push notifications
│   │   │   └── farcaster/    # Webhook handler
│   │   ├── clubs/            # Club pages
│   │   ├── games/            # Game detail pages
│   │   ├── layout.tsx        # Root layout
│   │   └── page.tsx          # Home (redirects to /clubs/hellfire/games)
│   ├── components/           # React components
│   │   ├── AuthProvider.tsx  # Auth context
│   │   ├── MiniAppInitializer.tsx
│   │   ├── PaymentButton.tsx
│   │   └── ...
│   └── lib/                  # Utilities
│       ├── auth.ts           # JWT verification
│       ├── neynar.ts         # Neynar client
│       ├── neynar-wallet.ts  # Wallet lookup
│       ├── pokerDb.ts        # Database wrapper
│       ├── supabase.ts       # Supabase client
│       ├── games.ts          # Game utilities
│       ├── eligibility.ts   # Eligibility checks
│       ├── notifications.ts # Notification helpers
│       └── ...
├── contracts/                # Solidity contracts
│   └── GameEscrow.sol
├── supabase_schema.sql       # Database schema
└── package.json
```

## API Routes

### Authentication
- `POST /api/auth/verify` - Verify JWT token, hydrate user profile

### Clubs
- `GET /api/clubs` - List clubs (auto-seeds Hellfire if empty)
- `GET /api/clubs/[id]/announcements` - Club announcements
- `GET /api/clubs/[id]/members` - Club members

### Games
- `GET /api/games?club_id=xxx` - List games with filters
- `POST /api/games` - Create game (admin only)
- `GET /api/games/[id]` - Get game details
- `POST /api/games/[id]/join` - Join game
- `POST /api/games/[id]/join-paid` - Join paid game
- `GET /api/games/[id]/password` - Get game password (gated)
- `GET /api/games/[id]/participants` - List participants
- `POST /api/games/[id]/results` - Record results (owner only)
- `POST /api/games/[id]/cancel` - Cancel game
- `POST /api/games/[id]/refund` - Refund participants
- `POST /api/games/[id]/settle-contract` - Settle escrow contract

### Payments
- `POST /api/payments/prepare` - Prepare payment (get recipient address)
- `POST /api/payments/confirm` - Confirm payment (verify transaction)
- `POST /api/payments/recover` - Recover payment status

### Notifications
- `POST /api/notifications/subscribe` - Subscribe to notifications
- `POST /api/notifications/broadcast` - Broadcast (admin only)
- `GET /api/notifications/status` - Get subscription status

### Admin
- `GET /api/admin/status` - Check admin status
- `POST /api/admin/blocks/[fid]` - Block user
- `DELETE /api/admin/blocks/[fid]` - Unblock user

## Environment Variables

### Required
```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_ROLE=...

# Neynar
NEYNAR_API_KEY=...

# App
NEXT_PUBLIC_BASE_URL=https://your-app.vercel.app

# Farcaster
FARCASTER_ASSOC_HEADER=... (optional, for signed manifests)
FARCASTER_ASSOC_PAYLOAD=...
FARCASTER_ASSOC_SIGNATURE=...
```

### Optional
```env
HELLFIRE_OWNER_FID=...
TORMENTAL_FID=...
NOTIFICATIONS_BROADCAST_ADMIN_FIDS=...
GAME_ESCROW_CONTRACT=...
BASE_RPC_URL=...
POKER_CREDS_ENCRYPTION_KEY=...
```

## Known Issues / TODOs

### From Code Review
1. **Crypto Library** (`lib/crypto.ts`):
   - TODO: Replace with proper encryption library
   - Currently uses simple base64 (MVP only)

2. **Betrmint Integration** (`lib/betrmint.ts`):
   - TODO: Replace with real Betrmint API integration
   - Currently stubbed

3. **Debug Logging**:
   - Extensive debug logging throughout (controlled by env vars)
   - `NEXT_PUBLIC_DEBUG_AUTH=1` for auth debugging
   - `NEXT_PUBLIC_DEBUG_PARTICIPANTS=1` for participant debugging

## Security Considerations

1. **Authentication**:
   - FID extracted ONLY from verified JWT (never from client)
   - Token verification uses domain from request host header
   - All API routes use `requireAuth()` wrapper

2. **Database**:
   - Service role key used server-side only
   - `pokerDb` wrapper enforces table allowlist
   - Schema isolation (`poker` schema)

3. **Payments**:
   - Blockchain transaction verification
   - Wallet address verification via Neynar
   - Escrow contract for secure payments

4. **Webhooks**:
   - Signature verification using `@farcaster/miniapp-node`
   - Always returns 200 to prevent retries
   - Only stores tokens if verification succeeds

## Testing

### Test Structure
- **Unit Tests**: `tests/unit/`
- **Integration Tests**: `tests/integration/`
- **E2E Tests**: `tests/e2e/` (Playwright)
- **Smoke Tests**: `scripts/smoke-test.ts`

### Running Tests
```bash
npm run test          # Unit + integration
npm run test:watch    # Watch mode
npm run test:e2e      # E2E tests
npm run test:smoke    # Production smoke test
```

## Deployment

- **Platform**: Vercel
- **Config**: `vercel.json`
- **Build**: `npm run build`
- **Framework**: Next.js (auto-detected)

## Next Steps for Debugging

1. **Check Environment Variables**: Ensure all required env vars are set
2. **Verify Database Schema**: Run `supabase_schema.sql` if needed
3. **Test Authentication**: Check JWT token flow
4. **Test API Routes**: Verify endpoints are working
5. **Check Logs**: Review console logs and error messages
6. **Test Payment Flow**: Verify blockchain interactions

---

**Note**: This app is separate from the "catwalk" mini app. Do not modify any files outside the `poker/` directory.

